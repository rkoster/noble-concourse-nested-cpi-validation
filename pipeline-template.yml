#@ load("@ytt:data", "data")
#@ load("@ytt:base64", "base64")

#@ start_bosh_b64 = base64.encode(data.values.start_bosh_script)

---
resources:
  - name: bosh-docker-cpi-image
    type: registry-image
    icon: docker
    source:
      repository: bosh/docker-cpi

  - name: warden-cpi-repo
    type: git
    icon: github
    source:
      uri: https://github.com/rkoster/noble-concourse-nested-cpi-validation.git
      branch: main

  - name: bosh-deployment-repo
    type: git
    icon: github
    source:
      uri: https://github.com/cloudfoundry/bosh-deployment.git
      branch: main

  - name: warden-cpi-containerd-image
    type: registry-image
    icon: docker
    source:
      repository: ((docker_registry_host))/warden-cpi-containerd
      username: admin
      password: ((docker_registry_password))
      insecure_registries: ["((docker_registry_host))"]

  - name: bosh-cli-image
    type: registry-image
    icon: docker
    source:
      repository: bosh/cli2

  - name: zookeeper-release
    type: git
    icon: github
    source:
      uri: https://github.com/cppforlife/zookeeper-release
      branch: master

jobs:
  - name: build-warden-cpi-containerd-image
    plan:
      - in_parallel:
          - get: warden-cpi-repo
            trigger: true
          - get: bosh-deployment-repo
          - get: bosh-cli-image

      - task: build-image
        privileged: true
        image: bosh-cli-image
        inputs:
          - name: warden-cpi-repo
          - name: bosh-deployment-repo
        outputs:
          - name: image
        params:
          DOCKER_REGISTRY_HOST: ((docker_registry_host))
          DOCKER_REGISTRY_USERNAME: admin
          DOCKER_REGISTRY_PASSWORD: ((docker_registry_password))
        config:
          platform: linux
          run:
            path: bash
            args:
              - -c
              - |
                set -euxo pipefail
                
                echo "=== Building warden-cpi image with containerd support ==="
                
                # Install Docker buildx for multi-platform builds
                apt-get update && apt-get install -y docker.io
                
                # Prepare build context
                cd warden-cpi-repo/warden-cpi-containerd
                cp -r ../../bosh-deployment-repo bosh-deployment
                
                # Build image
                docker build \
                  --build-arg BASE_IMAGE=ubuntu:noble \
                  -t ${DOCKER_REGISTRY_HOST}/warden-cpi-containerd:latest \
                  .
                
                # Login to registry  
                echo "${DOCKER_REGISTRY_PASSWORD}" | docker login \
                  ${DOCKER_REGISTRY_HOST} \
                  -u ${DOCKER_REGISTRY_USERNAME} \
                  --password-stdin
                
                # Push image
                docker push ${DOCKER_REGISTRY_HOST}/warden-cpi-containerd:latest
                
                echo "=== Image built and pushed successfully ==="

  - name: deploy-zookeeper-on-docker-bosh
    plan:
      - in_parallel:
          - get: bosh-docker-cpi-image
          - get: zookeeper-release
            trigger: false

      - task: start-bosh-and-deploy-zookeeper
        image: bosh-docker-cpi-image
        privileged: true
        config:
          platform: linux
          inputs:
            - name: zookeeper-release
          run:
            path: bash
            args:
              - -c
              - #@ "set -euo pipefail\n\necho \"=== Checking Disk Space ===\"\ndf -h /scratch\n\necho \"=== Cleaning up previous builds ===\"\nrm -rf /scratch/docker /tmp/local-bosh /tmp/tmp.* /root/.bosh || true\ndf -h /scratch\n\necho \"=== Creating patched start-bosh script from base64 ===\"\ncp /usr/local/bin/start-bosh /usr/local/bin/start-bosh.original\n\n# Decode base64-encoded patched script\nbase64 -d > /usr/local/bin/start-bosh <<'BASE64SCRIPT'\n" + start_bosh_b64 + "\nBASE64SCRIPT\n\nchmod +x /usr/local/bin/start-bosh\n\necho \"=== Starting BOSH Director with Docker CPI (patched version) ===\"\nstart-bosh\n\n# Source the environment variables\nsource /tmp/local-bosh/director/env\n\necho \"=== BOSH Director Environment ===\"\necho \"BOSH_ENVIRONMENT: ${BOSH_ENVIRONMENT}\"\necho \"BOSH_CLIENT: ${BOSH_CLIENT}\"\n\necho \"=== Verifying BOSH Director ===\"\nbosh env\n\necho \"=== Cloud Config ===\"\nbosh cloud-config\n\necho \"=== Creating and Uploading Zookeeper Release ===\"\ncd zookeeper-release\nbosh create-release --force --timestamp-version\nbosh upload-release\ncd ..\n\necho \"=== Uploading Stemcell ===\"\nbosh upload-stemcell --sha1 86662513fbbb9200aca8f0c24fa69e822f49e18c \\\n  https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-jammy-go_agent?v=1.631\n\necho \"=== Creating ops-file for single instance ===\"\ncat > /tmp/single-instance.yml <<'OPSFILE'\n---\n# Ops-file to deploy a single zookeeper instance instead of 5\n- type: replace\n  path: /instance_groups/name=zookeeper/instances\n  value: 1\n\n- type: replace\n  path: /instance_groups/name=zookeeper/azs\n  value: [z1]\n\n# Remove smoke-tests errand for simplicity\n- type: remove\n  path: /instance_groups/name=smoke-tests\n\n# Update stemcell to jammy\n- type: replace\n  path: /stemcells/alias=default/os\n  value: ubuntu-jammy\nOPSFILE\n\necho \"=== Deploying Zookeeper (Single Instance) ===\"\nbosh -n deploy \\\n  -d zookeeper \\\n  zookeeper-release/manifests/zookeeper.yml \\\n  -o /tmp/single-instance.yml\n\necho \"=== Deployment Status ===\"\nbosh -d zookeeper instances\n\necho \"=== Zookeeper VMs ===\"\nbosh -d zookeeper vms\n\necho \"=== Testing Zookeeper ===\"\n# SSH into the instance and check zookeeper status\nbosh -d zookeeper ssh zookeeper/0 -c \"\n  set -e\n  echo '=== Zookeeper Process Status ==='\n  sudo /var/vcap/bosh/bin/monit summary\n  \n  echo '=== Zookeeper Server Status ==='\n  echo stat | nc localhost 2181 || echo 'Could not connect to Zookeeper'\n\"\n\necho \"=== Cleaning Up ===\"\nbosh -d zookeeper -n delete-deployment\n\necho \"=== Pipeline Complete ===\"\n"
