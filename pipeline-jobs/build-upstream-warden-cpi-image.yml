  - name: build-upstream-warden-cpi-image
    plan:
      - in_parallel:
          - get: bosh-repo
            trigger: false
          - get: bosh-deployment-repo
            trigger: false
          - get: integration-image
            trigger: true
            passed: [build-integration-image]
            params:
              format: oci
          - get: oci-build-task
      - task: prepare-build-context
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: alpine
          inputs:
            - name: bosh-repo
            - name: bosh-deployment-repo
          outputs:
            - name: build-context
          run:
            path: sh
            args:
              - -exc
              - |
                #! Use pure upstream warden-cpi from noble-cut-over branch
                #! Base image: our locally-built integration image
                
                # Copy all upstream warden-cpi files
                cp bosh-repo/ci/dockerfiles/warden-cpi/Dockerfile build-context/
                cp bosh-repo/ci/dockerfiles/warden-cpi/install-garden.rb build-context/
                cp bosh-repo/ci/dockerfiles/warden-cpi/template-renderer.rb build-context/
                cp bosh-repo/ci/dockerfiles/warden-cpi/local-releases.yml build-context/
                cp bosh-repo/ci/dockerfiles/warden-cpi/start-bosh.sh build-context/
                
                # Copy bosh-deployment
                cp -r bosh-deployment-repo build-context/bosh-deployment
                
                echo "=== Build context (pure upstream noble-cut-over) ==="
                ls -la build-context/
                echo "=== Dockerfile ==="
                cat build-context/Dockerfile
                echo "=== start-bosh.sh (first 30 lines) ==="
                head -30 build-context/start-bosh.sh
      - task: build-image
        privileged: true
        image: oci-build-task
        timeout: 30m
        config:
          platform: linux
          inputs:
            - name: build-context
            - name: integration-image
          outputs:
            - name: image
          params:
            CONTEXT: build-context
            IMAGE_ARG_BASE_IMAGE: integration-image/image.tar
            BUILDKIT_PROGRESS: plain
          run:
            path: sh
            args:
              - -c
              - |
                echo "=== Building upstream warden-cpi image ==="
                echo "Base image: preloaded from integration-image (OCI format)"
                
                mount -t cgroup2 none /sys/fs/cgroup 2>/dev/null || true
                exec build
      - put: upstream-warden-cpi-image
        params:
          image: image/image.tar
        get_params:
          skip_download: true

