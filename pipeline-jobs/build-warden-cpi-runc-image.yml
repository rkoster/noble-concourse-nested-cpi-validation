  - name: build-warden-cpi-runc-image
    plan:
      - in_parallel:
          - get: warden-cpi-repo
            trigger: false
          - get: bosh-deployment-repo
            trigger: false
          - get: oci-build-task
      - task: prepare-build-context
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: alpine
          inputs:
            - name: warden-cpi-repo
            - name: bosh-deployment-repo
          outputs:
            - name: build-context
          run:
            path: sh
            args:
              - -exc
              - |
                # Copy runc-based warden-cpi configuration
                cp -r warden-cpi-repo/warden-cpi-runc/* build-context/
                
                # Copy necessary ops files
                mkdir -p build-context/ops-files
                cp warden-cpi-repo/ops-files/zookeeper-single-instance.yml build-context/ops-files/
                cp warden-cpi-repo/ops-files/docker-registry.yml build-context/ops-files/
                
                # Copy bosh-deployment manifests
                mkdir -p build-context/bosh-deployment
                cp -r bosh-deployment-repo/bosh.yml build-context/bosh-deployment/
                cp -r bosh-deployment-repo/bosh-lite.yml build-context/bosh-deployment/
                cp -r bosh-deployment-repo/docker build-context/bosh-deployment/
                cp -r bosh-deployment-repo/warden build-context/bosh-deployment/
                cp -r bosh-deployment-repo/uaa.yml build-context/bosh-deployment/
                cp -r bosh-deployment-repo/credhub.yml build-context/bosh-deployment/
                cp -r bosh-deployment-repo/jumpbox-user.yml build-context/bosh-deployment/
                
                # Show the install-garden-runc.rb configuration (GrootFS enabled by default)
                echo "=== Garden configuration ==="
                cat build-context/install-garden-runc.rb
                
                echo "Build context prepared for runc runtime with GrootFS enabled"
                ls -la build-context/
      - task: build-image
        privileged: true
        image: oci-build-task
        timeout: 30m
        config:
          platform: linux
          inputs:
            - name: build-context
          outputs:
            - name: image
          params:
            CONTEXT: build-context
            BUILD_ARG_BASE_IMAGE: "ubuntu:noble"
            BUILDKIT_PROGRESS: plain
          run:
            path: sh
            args:
              - -c
              - |
                echo "=== Building warden-cpi-runc image ==="
                # Mount cgroup2 to enable oci-build-task cgroup v2 detection
                # Guardian/gdn mounts a tmpfs at /sys/fs/cgroup but doesn't expose cgroup v2
                # This allows the setup-cgroups script to detect cgroup v2 and skip v1 setup
                mount -t cgroup2 none /sys/fs/cgroup 2>/dev/null || true
                exec build
      - put: warden-cpi-runc-image
        params:
          image: image/image.tar

