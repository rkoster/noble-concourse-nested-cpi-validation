  - name: build-noble-patched-stemcell-image
    plan:
      - in_parallel:
          - get: bosh-agent-fork
            trigger: false
          - get: oci-build-task
            trigger: false
      - task: prepare-build-context
        image: oci-build-task
        config:
          platform: linux
          inputs:
            - name: bosh-agent-fork
          outputs:
            - name: build-context
          run:
            path: sh
            args:
              - -exc
              - |
                set -eu
                echo "=== Preparing build context with multi-stage Dockerfile ==="

                # Copy agent source to build context
                cp -r bosh-agent-fork build-context/bosh-agent-fork

                # Create base firewall rules file
                # This only blocks outbound access to monit API by default
                # The agent will add exceptions for allowed cgroups at runtime
                #
                # NOTE: NATS firewall is NOT in the base rules. The agent dynamically adds
                # a rule that blocks ONLY the director's NATS IP (not all port 4222 traffic).
                # This is because other NATS servers (e.g., CF's internal NATS) must remain
                # accessible. The NATS firewall protects against metadata service attacks
                # where malicious workloads could extract NATS client certs and connect to
                # the director's NATS to impersonate agents.
                cat > build-context/base-firewall.nft <<'NFTABLES'
                #!/usr/sbin/nft -f
                #
                # BOSH Base Firewall Rules
                #
                # This file sets up the base nftables rules that block access to the
                # monit HTTP API by default. The bosh-agent will dynamically add rules
                # to allow specific cgroups (agent, monit) to access this service.
                #
                # Protected ports (outbound to localhost only):
                # - 2822: monit HTTP API (internal service, must be protected)
                #
                # NOT in base rules (agent manages dynamically):
                # - NATS: Agent adds rules for specific director IP only, not all port 4222
                #   This allows CF NATS and other NATS servers to remain accessible
                #
                # NOT blocked:
                # - Incoming traffic (needed for bosh create-env, agent API, etc.)
                #
                # Cross-table coordination:
                # The agent runs in a separate table (bosh_agent) with higher priority.
                # When it allows a packet, it sets mark 0xb054 ("BOSH" leet-ified).
                # This table checks for that mark and skips the DROP for marked packets.
                #

                table inet bosh_firewall {
                  # Chain for filtering outbound connections to monit
                  chain output_filter {
                    type filter hook output priority 0; policy accept;

                    # Allow established and related connections
                    ct state established,related accept

                    # Skip DROP if packet was marked as allowed by the agent
                    # The agent sets mark 0xb054 (45140 decimal) for packets it allows
                    meta mark 0xb054 accept

                    # Block outbound access to monit API on localhost by default
                    # The agent will add exceptions for its own cgroup
                    ip daddr 127.0.0.1 tcp dport 2822 drop
                  }
                }
                NFTABLES

                # Create systemd service file for base firewall
                cat > build-context/bosh-base-firewall.service <<'SERVICE'
                [Unit]
                Description=BOSH Base Firewall Rules
                DefaultDependencies=no
                Before=network-pre.target
                Wants=network-pre.target

                [Service]
                Type=oneshot
                ExecStart=/usr/sbin/nft -f /etc/nftables/bosh-base.nft
                ExecStop=/usr/sbin/nft delete table inet bosh_firewall
                RemainAfterExit=yes

                [Install]
                WantedBy=multi-user.target
                SERVICE

                # Create agent config for warden-cpi with NATS firewall enabled
                # This includes all warden-specific settings (from base_warden stage)
                # plus EnableNATSFirewall for agent-managed firewall rules
                cat > build-context/agent.json <<'AGENTCONFIG'
                {
                  "Platform": {
                    "Linux": {
                      "UseDefaultTmpDir": true,
                      "UsePreformattedPersistentDisk": true,
                      "BindMountPersistentDisk": true,
                      "SkipDiskSetup": true,
                      "ServiceManager": "systemd",
                      "EnableNATSFirewall": true
                    }
                  },
                  "Infrastructure": {
                    "Settings": {
                      "Sources": [
                        {
                          "Type": "File",
                          "SettingsPath": "/var/vcap/bosh/warden-cpi-agent-env.json"
                        }
                      ]
                    }
                  }
                }
                AGENTCONFIG

                # Create multi-stage Dockerfile
                cat > build-context/Dockerfile <<'DOCKERFILE'
                # Stage 1: Build bosh-agent from source
                FROM golang:1.24 AS builder
                WORKDIR /build
                COPY bosh-agent-fork/ .
                RUN go build -o bosh-agent ./main

                # Stage 2: Create patched stemcell image
                FROM ghcr.io/cloudfoundry/ubuntu-noble-stemcell:1.199

                # Copy the newly compiled bosh-agent with nftables firewall management
                COPY --from=builder /build/bosh-agent /var/vcap/bosh/bin/bosh-agent
                RUN chmod 755 /var/vcap/bosh/bin/bosh-agent

                # Install complete warden+firewall agent config
                # This replaces any existing agent.json with our complete config
                COPY agent.json /var/vcap/bosh/agent.json
                RUN chmod 600 /var/vcap/bosh/agent.json

                # Remove the stemcell's old monit nftables config
                RUN rm -f /etc/nftables/monit.nft /etc/nftables.d/monit.nft 2>/dev/null || true

                # Remove any nftables loading from monit.service if present
                RUN sed -i '/nft.*monit/d' /lib/systemd/system/monit.service 2>/dev/null || true

                # Install base firewall rules that block monit and NATS access by default
                # The agent's SetupAgentRules() will add exceptions at runtime
                RUN mkdir -p /etc/nftables
                COPY base-firewall.nft /etc/nftables/bosh-base.nft
                RUN chmod 644 /etc/nftables/bosh-base.nft

                # Install systemd service to load base firewall at boot
                COPY bosh-base-firewall.service /lib/systemd/system/bosh-base-firewall.service
                RUN systemctl enable bosh-base-firewall.service

                LABEL maintainer="noble-concourse-testing"
                LABEL description="Noble stemcell with agent-managed nftables firewall (NATS firewall enabled)"
                DOCKERFILE

                echo "=== Build context prepared ==="
                ls -la build-context/
      - task: build-image
        privileged: true
        image: oci-build-task
        timeout: 30m
        config:
          platform: linux
          inputs:
            - name: build-context
          outputs:
            - name: image
          params:
            CONTEXT: build-context
            BUILDKIT_PROGRESS: plain
          run:
            path: sh
            args:
              - -c
              - |
                echo "=== Building patched noble stemcell image with custom agent ==="
                mount -t cgroup2 none /sys/fs/cgroup 2>/dev/null || true
                exec build
      - put: noble-patched-stemcell-image
        params:
          image: image/image.tar
        get_params:
          skip_download: true

