  - name: deploy-zookeeper-on-upstream-warden
    plan:

      - in_parallel:
          - get: patched-warden-cpi-image
            trigger: true
            passed: [build-patched-warden-cpi-image]
          - get: noble-patched-stemcell-image
            trigger: true
            passed: [build-noble-patched-stemcell-image]
          - get: oci-build-task
          - get: zookeeper-release
      - task: create-light-stemcell
        image: oci-build-task
        config:
          platform: linux
          inputs:
            - name: noble-patched-stemcell-image
          outputs:
            - name: light-stemcell
          run:
            path: sh
            args:
              - -exc
              - |
                echo "=== Creating Light Stemcell Metadata ==="
                
                # Get the image digest from the resource metadata
                # The registry-image resource puts the digest in the 'digest' file
                if [ -f noble-patched-stemcell-image/digest ]; then
                  IMAGE_DIGEST=$(cat noble-patched-stemcell-image/digest)
                  echo "Found image digest: $IMAGE_DIGEST"
                else
                  echo "ERROR: No digest file found in noble-patched-stemcell-image"
                  ls -la noble-patched-stemcell-image/
                  exit 1
                fi
                
                REGISTRY_HOST="((docker_registry_host))"
                IMAGE_REFERENCE="${REGISTRY_HOST}/ubuntu-noble-stemcell-patched@${IMAGE_DIGEST}"
                OUTPUT_DIR="light-stemcell"
                
                mkdir -p "$OUTPUT_DIR"
                
                # Create stemcell metadata in BOSH standard format
                cat > "$OUTPUT_DIR/stemcell.MF" <<STEMCELL_MF
                ---
                name: bosh-warden-ubuntu-noble
                version: "light"
                api_version: 3
                bosh_protocol: '1'
                sha1: da39a3ee5e6b4b0d3255bfef95601890afd80709
                operating_system: ubuntu-noble
                stemcell_formats:
                - warden-light
                cloud_properties:
                  image_reference: "${IMAGE_REFERENCE}"
                STEMCELL_MF
                
                # Create empty image file (required by BOSH stemcell format)
                touch "$OUTPUT_DIR/image"
                
                echo "Stemcell metadata:"
                cat "$OUTPUT_DIR/stemcell.MF"
      - task: deploy-with-upstream-warden-cpi
        privileged: true
        image: patched-warden-cpi-image
        config:
          platform: linux
          inputs:
            - name: zookeeper-release
            - name: light-stemcell
          run:
            path: bash
            args:
              - -c
              - |
                set -euo pipefail
                
                echo "=== Upstream Warden CPI Test with Light Stemcell ==="
                echo "Latest upstream warden-cpi with new garden-cpi release"
                echo "Using light stemcells for fast deployment"
                
                # Mount cgroup filesystem for Garden
                echo "=== Setting up cgroup v2 ==="
                mkdir -p /sys/fs/cgroup
                mount -t cgroup2 none /sys/fs/cgroup || echo "cgroup2 already mounted"

                # Create light stemcell tarball BEFORE starting BOSH
                echo "=== Creating Light Stemcell Tarball ==="
                cd light-stemcell
                tar -czf /tmp/light-stemcell.tgz stemcell.MF image
                cd ..
                echo "Light stemcell tarball created at /tmp/light-stemcell.tgz"
                
                echo "=== Patching warden cpi ops-file for light stemcell ==="
                cat > /tmp/light-stemcell-cpi-patch.yml <<'CPIPATCH'
                # Remove sha1 check for light stemcells (no physical file to hash)
                - type: remove
                  path: /resource_pools/name=vms/stemcell/sha1
                
                # Replace stemcell URL with our light stemcell
                - type: replace
                  path: /resource_pools/name=vms/stemcell/url
                  value: file:///tmp/light-stemcell.tgz
                CPIPATCH
                
                cat /tmp/light-stemcell-cpi-patch.yml >> /usr/local/bosh-deployment/warden/cpi.yml
                
                echo "=== Patched warden/cpi.yml ==="
                tail -15 /usr/local/bosh-deployment/warden/cpi.yml
                
                # Modify grootfs config BEFORE starting BOSH
                # The grootfs_config.yml files were created at Docker image build time
                # but need the insecure registry added for our local registry
                echo "=== Configuring grootfs for insecure registry ==="
                
                # Modify both unprivileged and privileged grootfs configs
                for GROOTFS_CONFIG in \
                  "/var/vcap/jobs/garden/config/grootfs_config.yml" \
                  "/var/vcap/jobs/garden/config/privileged_grootfs_config.yml"
                do
                  if [ ! -f "$GROOTFS_CONFIG" ]; then
                    echo "ERROR: grootfs config not found at $GROOTFS_CONFIG"
                    echo "This file should exist in the upstream-warden-cpi Docker image"
                    exit 1
                  fi
                  
                  echo "Backing up original config: $GROOTFS_CONFIG"
                  cp "$GROOTFS_CONFIG" "${GROOTFS_CONFIG}.bak"
                  
                  echo "Modifying $GROOTFS_CONFIG to add insecure registry..."
                  ruby <<RUBY_SCRIPT
                require 'yaml'
                
                config_path = '${GROOTFS_CONFIG}'
                config = YAML.load_file(config_path)
                
                # Add insecure registry to create section
                config['create'] ||= {}
                config['create']['insecure_registries'] = ['10.246.0.21:5000']
                
                File.write(config_path, YAML.dump(config))
                puts "Updated #{config_path} with insecure registry: 10.246.0.21:5000"
                RUBY_SCRIPT
                  
                  echo "=== Updated $GROOTFS_CONFIG ==="
                  cat "$GROOTFS_CONFIG"
                  echo ""
                done
                
                # Add insecure registry configuration via BOSH ops-file (defense-in-depth)
                echo "=== Creating Garden ops-file for insecure registry ==="
                cat > /tmp/garden-insecure-registry.yml <<'GARDENOPS'
                # Configure Garden to allow insecure docker registries
                - type: replace
                  path: /instance_groups/name=bosh/jobs/name=garden/properties/garden/insecure_docker_registry_list?
                  value:
                    - "10.246.0.21:5000"
                GARDENOPS
                
                # Start BOSH Director using upstream start-bosh script
                echo "=== Starting BOSH Director ==="
                /usr/local/bin/start-bosh -o /tmp/garden-insecure-registry.yml || {
                  echo "=== start-bosh FAILED - collecting debug info ==="
                  
                  # Check garden containers
                  echo "=== Garden Containers ==="
                  /var/vcap/packages/guardian/bin/gaol list || true
                  
                  # Get container handle if any
                  CONTAINER=$(/var/vcap/packages/guardian/bin/gaol list | head -1 || true)
                  if [ -n "$CONTAINER" ]; then
                    echo "=== Logs from container: $CONTAINER ==="
                    
                    # Try to get agent logs
                    echo "=== Agent logs ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- cat /var/vcap/bosh/log/current 2>/dev/null || echo "No agent logs"
                    
                    # Try to get monit status
                    echo "=== Monit status ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- /var/vcap/bosh/bin/monit summary 2>/dev/null || echo "No monit"
                    
                    # Try to get systemd status
                    echo "=== Systemd status ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- systemctl status 2>/dev/null || echo "No systemctl"
                    
                    # Check if agent-env file exists
                    echo "=== Agent env file ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- cat /var/vcap/bosh/warden-cpi-agent-env.json 2>/dev/null || echo "No agent-env"
                    
                    # Check process list
                    echo "=== Processes ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- ps auxf 2>/dev/null || echo "ps failed"
                  fi
                  
                  # Garden logs
                  echo "=== Garden logs ==="
                  tail -100 /var/vcap/sys/log/garden/*.log 2>/dev/null || true
                  
                  exit 1
                }
                
                # Source BOSH environment
                source /tmp/local-bosh/director/env
                
                echo "=== BOSH Environment ==="
                bosh env
                
                # Upload light stemcell for zookeeper deployment
                echo "=== Uploading Light Stemcell to Director ==="
                bosh upload-stemcell /tmp/light-stemcell.tgz
                
                # Upload zookeeper release
                echo "=== Uploading Zookeeper Release ==="
                cd zookeeper-release
                bosh create-release --force --timestamp-version
                bosh upload-release
                cd ..
                
                # Deploy zookeeper using light stemcell
                echo "=== Deploying Zookeeper with Light Stemcell ==="
                cat > /tmp/light-stemcell-ops.yml <<'OPSFILE'
                ---
                - type: replace
                  path: /instance_groups/name=zookeeper/instances
                  value: 1
                - type: replace
                  path: /instance_groups/name=zookeeper/azs
                  value: [z1]
                - type: remove
                  path: /instance_groups/name=smoke-tests
                - type: replace
                  path: /stemcells
                  value:
                    - alias: default
                      os: ubuntu-noble
                      version: light
                OPSFILE
                
                bosh -n deploy \
                  -d zookeeper \
                  zookeeper-release/manifests/zookeeper.yml \
                  -o /tmp/light-stemcell-ops.yml
                
                echo "=== Zookeeper Deployment Status ==="
                bosh -d zookeeper instances --details
                bosh -d zookeeper vms --vitals
                
                # Verify agent-managed firewall in zookeeper container
                echo "=== Verifying Agent-Managed Firewall ==="
                
                # Architecture:
                # - Concourse task container runs Garden
                # - Garden runs BOSH director container
                # - BOSH director uses warden-cpi to create nested containers for VMs
                # - Zookeeper VM is a nested Garden container managed by director's warden-cpi
                #
                # The zookeeper container is created by the warden-cpi, and its data
                # is stored alongside the director container in /var/vcap/data/garden/depot
                
                RUNC=/var/vcap/packages/runc/bin/runc
                DEPOT=/var/vcap/data/garden/depot
                
                echo "=== Finding containers ==="
                ls -la "$DEPOT" 2>/dev/null || echo "No depot directory"
                
                # List all containers - should be director + zookeeper
                CONTAINERS=$(ls -t "$DEPOT" 2>/dev/null)
                echo "Containers found:"
                echo "$CONTAINERS"
                
                # The zookeeper container should be the most recently created
                # (created after the director during bosh deploy)
                for CONTAINER in $CONTAINERS; do
                  echo ""
                  echo "=== Inspecting container: $CONTAINER ==="
                  
                  # Check if this looks like a zookeeper VM by looking at agent files
                  echo "Checking for BOSH agent files..."
                  $RUNC --root /run/runc exec "$CONTAINER" ls -la /var/vcap/bosh/ 2>/dev/null | head -10 || echo "No /var/vcap/bosh/"
                  
                  # Check agent.json
                  echo "=== agent.json ==="
                  $RUNC --root /run/runc exec "$CONTAINER" cat /var/vcap/bosh/agent.json 2>/dev/null || echo "No agent.json"
                  
                  # Check nftables rules
                  echo "=== nftables rules ==="
                  $RUNC --root /run/runc exec "$CONTAINER" nft list ruleset 2>/dev/null || echo "nft not available"
                  
                  # Check agent logs for firewall
                  echo "=== Agent log (firewall entries) ==="
                  $RUNC --root /run/runc exec "$CONTAINER" cat /var/vcap/bosh/log/current 2>/dev/null | grep -i -E "(firewall|nftables|nats)" | tail -20 || echo "No firewall entries"
                  
                  # Show agent log tail
                  echo "=== Agent log tail ==="
                  $RUNC --root /run/runc exec "$CONTAINER" tail -30 /var/vcap/bosh/log/current 2>/dev/null || echo "No agent log"
                done
                
                echo "=== SUCCESS: Upstream Warden CPI with Light Stemcell ==="
                echo ""
                echo "=== Keeping environment alive for debugging ==="
                echo "Hijack into this task to inspect the zookeeper container:"
                echo "  fly -t local hijack -j nested-bosh-zookeeper/deploy-zookeeper-on-upstream-warden --step deploy-with-upstream-warden-cpi"
                echo ""
                echo "Useful commands inside hijacked container:"
                echo "  source /tmp/local-bosh/director/env"
                echo "  bosh -d zookeeper ssh zookeeper/0"
                echo "  RUNC=/var/vcap/packages/runc/bin/runc"
                echo '  $RUNC --root /run/runc exec <container-id> nft list ruleset'
                echo '  $RUNC --root /run/runc exec <container-id> cat /var/vcap/bosh/log/current'
                echo ""
                echo "Sleeping for 1 hour... (Ctrl+C or abort job to stop)"
                sleep 3600
                
                echo "=== Cleaning Up ==="
                bosh -d zookeeper -n delete-deployment || true

