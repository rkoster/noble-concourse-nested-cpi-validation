  - name: deploy-zookeeper-on-upstream-warden
    plan:

      - in_parallel:
          - get: patched-warden-cpi-image
            trigger: true
            passed: [build-patched-warden-cpi-image]
          - get: noble-patched-stemcell-image
            trigger: true
            passed: [build-noble-patched-stemcell-image]
          - get: oci-build-task
          - get: zookeeper-release
      - task: create-light-stemcell
        image: oci-build-task
        config:
          platform: linux
          outputs:
            - name: light-stemcell
          run:
            path: sh
            args:
              - -exc
              - |
                echo "=== Creating Light Stemcell Metadata ==="
                
                IMAGE_URL="((docker_registry_host))/ubuntu-noble-stemcell-patched:latest"
                OUTPUT_DIR="light-stemcell"
                
                mkdir -p "$OUTPUT_DIR"
                
                # Create stemcell metadata in BOSH standard format
                cat > "$OUTPUT_DIR/stemcell.MF" <<'STEMCELL_MF'
                ---
                name: bosh-warden-ubuntu-noble
                version: "light"
                api_version: 3
                bosh_protocol: '1'
                sha1: da39a3ee5e6b4b0d3255bfef95601890afd80709
                operating_system: ubuntu-noble
                stemcell_formats:
                - warden-light
                cloud_properties:
                  image_reference: "10.246.0.21:5000/ubuntu-noble-stemcell-patched@sha256:7a855a426c98e327306174f60c362c2180b787f79baabc3a593796015190012f"
                STEMCELL_MF
                
                # Create empty image file (required by BOSH stemcell format)
                touch "$OUTPUT_DIR/image"
                
                echo "Stemcell metadata:"
                cat "$OUTPUT_DIR/stemcell.MF"
      - task: deploy-with-upstream-warden-cpi
        privileged: true
        image: patched-warden-cpi-image
        config:
          platform: linux
          inputs:
            - name: zookeeper-release
            - name: light-stemcell
          run:
            path: bash
            args:
              - -c
              - |
                set -euo pipefail
                
                echo "=== Upstream Warden CPI Test with Light Stemcell ==="
                echo "Latest upstream warden-cpi with new garden-cpi release"
                echo "Using light stemcells for fast deployment"
                
                # Mount cgroup filesystem for Garden
                echo "=== Setting up cgroup v2 ==="
                mkdir -p /sys/fs/cgroup
                mount -t cgroup2 none /sys/fs/cgroup || echo "cgroup2 already mounted"

                # Create light stemcell tarball BEFORE starting BOSH
                echo "=== Creating Light Stemcell Tarball ==="
                cd light-stemcell
                tar -czf /tmp/light-stemcell.tgz stemcell.MF image
                cd ..
                echo "Light stemcell tarball created at /tmp/light-stemcell.tgz"
                
                echo "=== Patching warden cpi ops-file for light stemcell ==="
                cat > /tmp/light-stemcell-cpi-patch.yml <<'CPIPATCH'
                # Remove sha1 check for light stemcells (no physical file to hash)
                - type: remove
                  path: /resource_pools/name=vms/stemcell/sha1
                
                # Replace stemcell URL with our light stemcell
                - type: replace
                  path: /resource_pools/name=vms/stemcell/url
                  value: file:///tmp/light-stemcell.tgz
                CPIPATCH
                
                cat /tmp/light-stemcell-cpi-patch.yml >> /usr/local/bosh-deployment/warden/cpi.yml
                
                echo "=== Patched warden/cpi.yml ==="
                tail -15 /usr/local/bosh-deployment/warden/cpi.yml
                
                # Modify grootfs config BEFORE starting BOSH
                # The grootfs_config.yml files were created at Docker image build time
                # but need the insecure registry added for our local registry
                echo "=== Configuring grootfs for insecure registry ==="
                
                # Modify both unprivileged and privileged grootfs configs
                for GROOTFS_CONFIG in \
                  "/var/vcap/jobs/garden/config/grootfs_config.yml" \
                  "/var/vcap/jobs/garden/config/privileged_grootfs_config.yml"
                do
                  if [ ! -f "$GROOTFS_CONFIG" ]; then
                    echo "ERROR: grootfs config not found at $GROOTFS_CONFIG"
                    echo "This file should exist in the upstream-warden-cpi Docker image"
                    exit 1
                  fi
                  
                  echo "Backing up original config: $GROOTFS_CONFIG"
                  cp "$GROOTFS_CONFIG" "${GROOTFS_CONFIG}.bak"
                  
                  echo "Modifying $GROOTFS_CONFIG to add insecure registry..."
                  ruby <<RUBY_SCRIPT
                require 'yaml'
                
                config_path = '${GROOTFS_CONFIG}'
                config = YAML.load_file(config_path)
                
                # Add insecure registry to create section
                config['create'] ||= {}
                config['create']['insecure_registries'] = ['10.246.0.21:5000']
                
                File.write(config_path, YAML.dump(config))
                puts "Updated #{config_path} with insecure registry: 10.246.0.21:5000"
                RUBY_SCRIPT
                  
                  echo "=== Updated $GROOTFS_CONFIG ==="
                  cat "$GROOTFS_CONFIG"
                  echo ""
                done
                
                # Add insecure registry configuration via BOSH ops-file (defense-in-depth)
                echo "=== Creating Garden ops-file for insecure registry ==="
                cat > /tmp/garden-insecure-registry.yml <<'GARDENOPS'
                # Configure Garden to allow insecure docker registries
                - type: replace
                  path: /instance_groups/name=bosh/jobs/name=garden/properties/garden/insecure_docker_registry_list?
                  value:
                    - "10.246.0.21:5000"
                GARDENOPS
                
                # Start BOSH Director using upstream start-bosh script
                echo "=== Starting BOSH Director ==="
                /usr/local/bin/start-bosh -o /tmp/garden-insecure-registry.yml || {
                  echo "=== start-bosh FAILED - collecting debug info ==="
                  
                  # Check garden containers
                  echo "=== Garden Containers ==="
                  /var/vcap/packages/guardian/bin/gaol list || true
                  
                  # Get container handle if any
                  CONTAINER=$(/var/vcap/packages/guardian/bin/gaol list | head -1 || true)
                  if [ -n "$CONTAINER" ]; then
                    echo "=== Logs from container: $CONTAINER ==="
                    
                    # Try to get agent logs
                    echo "=== Agent logs ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- cat /var/vcap/bosh/log/current 2>/dev/null || echo "No agent logs"
                    
                    # Try to get monit status
                    echo "=== Monit status ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- /var/vcap/bosh/bin/monit summary 2>/dev/null || echo "No monit"
                    
                    # Try to get systemd status
                    echo "=== Systemd status ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- systemctl status 2>/dev/null || echo "No systemctl"
                    
                    # Check if agent-env file exists
                    echo "=== Agent env file ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- cat /var/vcap/bosh/warden-cpi-agent-env.json 2>/dev/null || echo "No agent-env"
                    
                    # Check process list
                    echo "=== Processes ==="
                    /var/vcap/packages/guardian/bin/gaol run "$CONTAINER" -- ps auxf 2>/dev/null || echo "ps failed"
                  fi
                  
                  # Garden logs
                  echo "=== Garden logs ==="
                  tail -100 /var/vcap/sys/log/garden/*.log 2>/dev/null || true
                  
                  exit 1
                }
                
                # Source BOSH environment
                source /tmp/local-bosh/director/env
                
                echo "=== BOSH Environment ==="
                bosh env
                
                # Upload light stemcell for zookeeper deployment
                echo "=== Uploading Light Stemcell to Director ==="
                bosh upload-stemcell /tmp/light-stemcell.tgz
                
                # Upload zookeeper release
                echo "=== Uploading Zookeeper Release ==="
                cd zookeeper-release
                bosh create-release --force --timestamp-version
                bosh upload-release
                cd ..
                
                # Deploy zookeeper using light stemcell
                echo "=== Deploying Zookeeper with Light Stemcell ==="
                cat > /tmp/light-stemcell-ops.yml <<'OPSFILE'
                ---
                - type: replace
                  path: /instance_groups/name=zookeeper/instances
                  value: 1
                - type: replace
                  path: /instance_groups/name=zookeeper/azs
                  value: [z1]
                - type: remove
                  path: /instance_groups/name=smoke-tests
                - type: replace
                  path: /stemcells
                  value:
                    - alias: default
                      os: ubuntu-noble
                      version: light
                OPSFILE
                
                bosh -n deploy \
                  -d zookeeper \
                  zookeeper-release/manifests/zookeeper.yml \
                  -o /tmp/light-stemcell-ops.yml
                
                echo "=== Zookeeper Deployment Status ==="
                bosh -d zookeeper instances --details
                bosh -d zookeeper vms --vitals
                
                echo "=== Cleaning Up ==="
                bosh -d zookeeper -n delete-deployment
                
                echo "=== SUCCESS: Upstream Warden CPI with Light Stemcell ==="

