  - name: deploy-zookeeper-on-upstream-warden
    plan:

      - in_parallel:
          - get: upstream-warden-cpi-image
            trigger: true
            passed: [build-upstream-warden-cpi-image]
          - get: noble-patched-stemcell-image
            trigger: true
            passed: [build-noble-patched-stemcell-image]
          - get: oci-build-task
          - get: zookeeper-release
      - task: create-light-stemcell
        image: oci-build-task
        config:
          platform: linux
          outputs:
            - name: light-stemcell
          run:
            path: sh
            args:
              - -exc
              - |
                echo "=== Creating Light Stemcell Metadata ==="
                
                IMAGE_URL="((docker_registry_host))/ubuntu-noble-stemcell-patched:latest"
                OUTPUT_DIR="light-stemcell"
                
                mkdir -p "$OUTPUT_DIR"
                
                # Create stemcell metadata in BOSH standard format
                cat > "$OUTPUT_DIR/stemcell.MF" <<'STEMCELL_MF'
                ---
                name: bosh-warden-ubuntu-noble
                version: "light"
                api_version: 3
                bosh_protocol: '1'
                sha1: da39a3ee5e6b4b0d3255bfef95601890afd80709
                operating_system: ubuntu-noble
                stemcell_formats:
                - warden-light
                cloud_properties:
                  image_reference: "10.246.0.21:5000/ubuntu-noble-stemcell-patched@sha256:7a855a426c98e327306174f60c362c2180b787f79baabc3a593796015190012f"
                STEMCELL_MF
                
                # Create empty image file (required by BOSH stemcell format)
                touch "$OUTPUT_DIR/image"
                
                echo "Stemcell metadata:"
                cat "$OUTPUT_DIR/stemcell.MF"
      - task: deploy-with-upstream-warden-cpi
        privileged: true
        image: upstream-warden-cpi-image
        config:
          platform: linux
          inputs:
            - name: zookeeper-release
            - name: light-stemcell
          run:
            path: bash
            args:
              - -c
              - |
                set -euo pipefail
                
                echo "=== Upstream Warden CPI Test with Light Stemcell ==="
                echo "Latest upstream warden-cpi with new garden-cpi release"
                echo "Using light stemcells for fast deployment"
                
                # Mount cgroup filesystem for Garden
                echo "=== Setting up cgroup v2 ==="
                mkdir -p /sys/fs/cgroup
                mount -t cgroup2 none /sys/fs/cgroup || echo "cgroup2 already mounted"

                # Create light stemcell tarball BEFORE starting BOSH
                echo "=== Creating Light Stemcell Tarball ==="
                cd light-stemcell
                tar -czf /tmp/light-stemcell.tgz stemcell.MF image
                cd ..
                echo "Light stemcell tarball created at /tmp/light-stemcell.tgz"
                
                echo "=== Patching warden cpi ops-file for light stemcell ==="
                cat > /tmp/light-stemcell-cpi-patch.yml <<'CPIPATCH'
                # Remove sha1 check for light stemcells (no physical file to hash)
                - type: remove
                  path: /resource_pools/name=vms/stemcell/sha1
                
                # Replace stemcell URL with our light stemcell
                - type: replace
                  path: /resource_pools/name=vms/stemcell/url
                  value: file:///tmp/light-stemcell.tgz
                CPIPATCH
                
                cat /tmp/light-stemcell-cpi-patch.yml >> /usr/local/bosh-deployment/warden/cpi.yml
                
                echo "=== Patched warden/cpi.yml ==="
                tail -15 /usr/local/bosh-deployment/warden/cpi.yml
                
                # Add insecure registry configuration for Garden
                echo "=== Configuring Garden for Insecure Docker Registry ==="
                cat > /tmp/garden-insecure-registry.yml <<'GARDENOPS'
                # Configure Garden to allow insecure docker registries
                - type: replace
                  path: /instance_groups/name=bosh/jobs/name=garden/properties/garden/insecure_docker_registries?
                  value:
                    - "10.246.0.21:5000"
                GARDENOPS
                
                # Use upstream start-bosh script with additional ops file
                echo "=== Starting BOSH Director ==="
                /usr/local/bin/start-bosh -o /tmp/garden-insecure-registry.yml
                
                # Source BOSH environment
                source /tmp/local-bosh/director/env
                
                echo "=== BOSH Environment ==="
                bosh env
                
                # Upload light stemcell for zookeeper deployment
                echo "=== Uploading Light Stemcell to Director ==="
                bosh upload-stemcell /tmp/light-stemcell.tgz
                
                # Upload zookeeper release
                echo "=== Uploading Zookeeper Release ==="
                cd zookeeper-release
                bosh create-release --force --timestamp-version
                bosh upload-release
                cd ..
                
                # Deploy zookeeper using light stemcell
                echo "=== Deploying Zookeeper with Light Stemcell ==="
                cat > /tmp/light-stemcell-ops.yml <<'OPSFILE'
                ---
                - type: replace
                  path: /instance_groups/name=zookeeper/instances
                  value: 1
                - type: replace
                  path: /instance_groups/name=zookeeper/azs
                  value: [z1]
                - type: remove
                  path: /instance_groups/name=smoke-tests
                - type: replace
                  path: /stemcells
                  value:
                    - alias: default
                      os: ubuntu-noble
                      version: light
                OPSFILE
                
                bosh -n deploy \
                  -d zookeeper \
                  zookeeper-release/manifests/zookeeper.yml \
                  -o /tmp/light-stemcell-ops.yml
                
                echo "=== Zookeeper Deployment Status ==="
                bosh -d zookeeper instances --details
                bosh -d zookeeper vms --vitals
                
                echo "=== Cleaning Up ==="
                bosh -d zookeeper -n delete-deployment
                
                echo "=== SUCCESS: Upstream Warden CPI with Light Stemcell ==="

