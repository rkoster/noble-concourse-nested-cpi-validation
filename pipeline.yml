---
resources:
  - name: bosh-docker-cpi-image
    type: registry-image
    icon: docker
    source:
      repository: bosh/docker-cpi

  - name: bosh-warden-cpi-image
    type: registry-image
    icon: docker
    source:
      repository: bosh/warden-cpi

  - name: zookeeper-release
    type: git
    icon: github
    source:
      uri: https://github.com/cppforlife/zookeeper-release
      branch: master

jobs:
  - name: deploy-zookeeper-on-docker-bosh
    plan:
      - in_parallel:
          - get: bosh-docker-cpi-image
          - get: zookeeper-release
            trigger: false

      - task: start-bosh-and-deploy-zookeeper
        image: bosh-docker-cpi-image
        privileged: true
        config:
          platform: linux
          inputs:
            - name: zookeeper-release
          run:
            path: bash
            args:
              - -c
              - |
                set -euo pipefail
                
                echo "=== Creating patched start-bosh script from base64 ==="
                cp /usr/local/bin/start-bosh /usr/local/bin/start-bosh.original
                
                # Decode base64-encoded patched script
                base64 -d > /usr/local/bin/start-bosh <<'BASE64SCRIPT'
                IyEvdXNyL2Jpbi9lbnYgYmFzaAoKc2V0IC1lCgpmdW5jdGlvbiBnZW5lcmF0ZV9jZXJ0cygpIHsKICBsb2NhbCBjZXJ0c19kaXIKICBjZXJ0c19kaXI9IiR7MX0iCgogIHB1c2hkICIke2NlcnRzX2Rpcn0iID4gL2Rldi9udWxsCiAgICBjYXQgPDxFT0YgPiAuL2Jvc2gtdmFycy55bWwKLS0tCnZhcmlhYmxlczoKLSBuYW1lOiBkb2NrZXJfY2EKICB0eXBlOiBjZXJ0aWZpY2F0ZQogIG9wdGlvbnM6CiAgICBpc19jYTogdHJ1ZQogICAgY29tbW9uX25hbWU6IGNhCi0gbmFtZTogZG9ja2VyX3RscwogIHR5cGU6IGNlcnRpZmljYXRlCiAgb3B0aW9uczoKICAgIGV4dGVuZGVkX2tleV91c2FnZTogW3NlcnZlcl9hdXRoXQogICAgY29tbW9uX25hbWU6ICRPVVRFUl9DT05UQUlORVJfSVAKICAgIGFsdGVybmF0aXZlX25hbWVzOiBbJE9VVEVSX0NPTlRBSU5FUl9JUF0KICAgIGNhOiBkb2NrZXJfY2EKLSBuYW1lOiBjbGllbnRfZG9ja2VyX3RscwogIHR5cGU6IGNlcnRpZmljYXRlCiAgb3B0aW9uczoKICAgIGV4dGVuZGVkX2tleV91c2FnZTogW2NsaWVudF9hdXRoXQogICAgY29tbW9uX25hbWU6ICRPVVRFUl9DT05UQUlORVJfSVAKICAgIGFsdGVybmF0aXZlX25hbWVzOiBbJE9VVEVSX0NPTlRBSU5FUl9JUF0KICAgIGNhOiBkb2NrZXJfY2EKRU9GCgogICBib3NoIGludCAuL2Jvc2gtdmFycy55bWwgLS12YXJzLXN0b3JlPS4vY2VydHMueW1sCiAgIGJvc2ggaW50IC4vY2VydHMueW1sIC0tcGF0aD0vZG9ja2VyX2NhL2NhID4gLi9jYS5wZW0KICAgYm9zaCBpbnQgLi9jZXJ0cy55bWwgLS1wYXRoPS9kb2NrZXJfdGxzL2NlcnRpZmljYXRlID4gLi9zZXJ2ZXItY2VydC5wZW0KICAgYm9zaCBpbnQgLi9jZXJ0cy55bWwgLS1wYXRoPS9kb2NrZXJfdGxzL3ByaXZhdGVfa2V5ID4gLi9zZXJ2ZXIta2V5LnBlbQogICBib3NoIGludCAuL2NlcnRzLnltbCAtLXBhdGg9L2NsaWVudF9kb2NrZXJfdGxzL2NlcnRpZmljYXRlID4gLi9jZXJ0LnBlbQogICBib3NoIGludCAuL2NlcnRzLnltbCAtLXBhdGg9L2NsaWVudF9kb2NrZXJfdGxzL3ByaXZhdGVfa2V5ID4gLi9rZXkucGVtCiAgICAjIGdlbmVyYXRlIGNlcnRzIGluIGpzb24gZm9ybWF0CiAgICAjCiAgIHJ1YnkgLWUgJ3B1dHMgRmlsZS5yZWFkKCIuL2NhLnBlbSIpLnNwbGl0KCJcbiIpLmpvaW4oIlxcbiIpJyA+ICRjZXJ0c19kaXIvY2FfanNvbl9zYWZlLnBlbQogICBydWJ5IC1lICdwdXRzIEZpbGUucmVhZCgiLi9jZXJ0LnBlbSIpLnNwbGl0KCJcbiIpLmpvaW4oIlxcbiIpJyA+ICRjZXJ0c19kaXIvY2xpZW50X2NlcnRpZmljYXRlX2pzb25fc2FmZS5wZW0KICAgcnVieSAtZSAncHV0cyBGaWxlLnJlYWQoIi4va2V5LnBlbSIpLnNwbGl0KCJcbiIpLmpvaW4oIlxcbiIpJyA+ICRjZXJ0c19kaXIvY2xpZW50X3ByaXZhdGVfa2V5X2pzb25fc2FmZS5wZW0KICBwb3BkID4gL2Rldi9udWxsCn0KCmZ1bmN0aW9uIHNhbml0aXplX2Nncm91cHMoKSB7CiAgIyBQQVRDSDogRGV0ZWN0IGNncm91cCB2MiBhbmQgc2tpcCB2MS1zcGVjaWZpYyBzZXR1cAogICMgQ2hlY2sgaWYgd2UncmUgcnVubmluZyB1bmRlciBjZ3JvdXAgdjIgKHVuaWZpZWQgaGllcmFyY2h5KQogICMgSW4gY2dyb3VwIHYyLCBhbGwgY29udHJvbGxlcnMgc2hvdyBoaWVyYXJjaHkgMCBpbiAvcHJvYy9jZ3JvdXBzCiAgIyBhbmQgL3Byb2Mvc2VsZi9jZ3JvdXAgaGFzIGEgc2luZ2xlIGxpbmUgc3RhcnRpbmcgd2l0aCAiMDo6IgogIGlmIGdyZXAgLXEgIl4wOjoiIC9wcm9jL3NlbGYvY2dyb3VwIDI+L2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJEZXRlY3RlZCBjZ3JvdXAgdjIgKHVuaWZpZWQgaGllcmFyY2h5KSAtIHNraXBwaW5nIHYxLXNwZWNpZmljIGNncm91cCBzZXR1cCIKICAgIGVjaG8gIkRvY2tlciB3aWxsIGhhbmRsZSBjZ3JvdXAgdjIgbmF0aXZlbHkiCiAgICByZXR1cm4gMAogIGZpCiAgCiAgIyBPcmlnaW5hbCBjZ3JvdXAgdjEgc2V0dXAgbG9naWMgZm9sbG93cy4uLgogIGVjaG8gIkRldGVjdGVkIGNncm91cCB2MSAtIHBlcmZvcm1pbmcgc3RhbmRhcmQgY2dyb3VwIHNldHVwIgogIAogIG1rZGlyIC1wIC9zeXMvZnMvY2dyb3VwCiAgbW91bnRwb2ludCAtcSAvc3lzL2ZzL2Nncm91cCB8fCBcCiAgICBtb3VudCAtdCB0bXBmcyAtbyB1aWQ9MCxnaWQ9MCxtb2RlPTA3NTUgY2dyb3VwIC9zeXMvZnMvY2dyb3VwCgogIG1vdW50IC1vIHJlbW91bnQscncgL3N5cy9mcy9jZ3JvdXAKCiAgc2VkIC1lIDFkIC9wcm9jL2Nncm91cHMgfCB3aGlsZSByZWFkIHN5cyBoaWVyYXJjaHkgbnVtIGVuYWJsZWQ7IGRvCiAgICBpZiBbICIkZW5hYmxlZCIgIT0gIjEiIF07IHRoZW4KICAgICAgIyBzdWJzeXN0ZW0gZGlzYWJsZWQ7IHNraXAKICAgICAgY29udGludWUKICAgIGZpCgogICAgZ3JvdXBpbmc9IiQoY2F0IC9wcm9jL3NlbGYvY2dyb3VwIHwgY3V0IC1kOiAtZjIgfCBncmVwICJcXDwkc3lzXFw+IikiCiAgICBpZiBbIC16ICIkZ3JvdXBpbmciIF07IHRoZW4KICAgICAgIyBzdWJzeXN0ZW0gbm90IG1vdW50ZWQgYW55d2hlcmU7IG1vdW50IGl0IG9uIGl0cyBvd24KICAgICAgZ3JvdXBpbmc9IiRzeXMiCiAgICBmaQoKICAgIG1vdW50cG9pbnQ9Ii9zeXMvZnMvY2dyb3VwLyRncm91cGluZyIKCiAgICBta2RpciAtcCAiJG1vdW50cG9pbnQiCgogICAgIyBjbGVhciBvdXQgZXhpc3RpbmcgbW91bnQgdG8gbWFrZSBzdXJlIG5ldyBvbmUgaXMgcmVhZC13cml0ZQogICAgaWYgbW91bnRwb2ludCAtcSAiJG1vdW50cG9pbnQiOyB0aGVuCiAgICAgIHVtb3VudCAiJG1vdW50cG9pbnQiCiAgICBmaQoKICAgIG1vdW50IC1uIC10IGNncm91cCAtbyAiJGdyb3VwaW5nIiBjZ3JvdXAgIiRtb3VudHBvaW50IgoKICAgIGlmIFsgIiRncm91cGluZyIgIT0gIiRzeXMiIF07IHRoZW4KICAgICAgaWYgWyAtTCAiL3N5cy9mcy9jZ3JvdXAvJHN5cyIgXTsgdGhlbgogICAgICAgIHJtICIvc3lzL2ZzL2Nncm91cC8kc3lzIgogICAgICBmaQoKICAgICAgbG4gLXMgIiRtb3VudHBvaW50IiAiL3N5cy9mcy9jZ3JvdXAvJHN5cyIKICAgIGZpCiAgZG9uZQp9CgpmdW5jdGlvbiBzdG9wX2RvY2tlcigpIHsKICBzZXJ2aWNlIGRvY2tlciBzdG9wCn0KCmZ1bmN0aW9uIHN0YXJ0X2RvY2tlcigpIHsKICAjIGRvY2tlciB3aWxsIGZhaWwgc3RhcnRpbmcgd2l0aCB0aGUgbmV3IGlwdGFibGVzLiBpdCB0aHJvd3M6CiAgIyBpcHRhYmxlcyB2MS44LjcgKG5mX3RhYmxlcyk6IENvdWxkIG5vdCBmZXRjaCBydWxlIHNldCBnZW5lcmF0aW9uIGlkOiAuLi4uCiAgdXBkYXRlLWFsdGVybmF0aXZlcyAtLXNldCBpcHRhYmxlcyAvdXNyL3NiaW4vaXB0YWJsZXMtbGVnYWN5CiAgZ2VuZXJhdGVfY2VydHMgJDEKICBta2RpciAtcCAvdmFyL2xvZwogIG1rZGlyIC1wIC92YXIvcnVuCgogIHNhbml0aXplX2Nncm91cHMKCiAgIyBlbnN1cmUgc3lzdGVtZCBjZ3JvdXAgaXMgcHJlc2VudAogIG1rZGlyIC1wIC9zeXMvZnMvY2dyb3VwL3N5c3RlbWQKICBpZiAhIG1vdW50cG9pbnQgLXEgL3N5cy9mcy9jZ3JvdXAvc3lzdGVtZCA7IHRoZW4KICAgIG1vdW50IC10IGNncm91cCAtbyBub25lLG5hbWU9c3lzdGVtZCBjZ3JvdXAgL3N5cy9mcy9jZ3JvdXAvc3lzdGVtZAogIGZpCgogICMgY2hlY2sgZm9yIC9wcm9jL3N5cyBiZWluZyBtb3VudGVkIHJlYWRvbmx5LCBhcyBzeXN0ZW1kIGRvZXMKICBpZiBncmVwICcvcHJvYy9zeXNcc1wrXHdcK1xzXCtybywnIC9wcm9jL21vdW50cyA+L2Rldi9udWxsOyB0aGVuCiAgICBtb3VudCAtbyByZW1vdW50LHJ3IC9wcm9jL3N5cwogIGZpCgogIGxvY2FsIG10dT0kKGNhdCAvc3lzL2NsYXNzL25ldC8kKGlwIHJvdXRlIGdldCAxNjkuMjU0LjE2OS4yNTR8YXdrICd7IHByaW50ICQ1IH0nKS9tdHUpCgogIFtbICEgLWQgL2V0Yy9kb2NrZXIgXV0gJiYgbWtkaXIgL2V0Yy9kb2NrZXIKICBjYXQgPDxFT0YgPiAvZXRjL2RvY2tlci9kYWVtb24uanNvbgp7CiAgImhvc3RzIjogWyIke0RPQ0tFUl9IT1NUfSJdLAogICJ0bHMiOiB0cnVlLAogICJ0bHNjZXJ0IjogIiR7Y2VydHNfZGlyfS9zZXJ2ZXItY2VydC5wZW0iLAogICJ0bHNrZXkiOiAiJHtjZXJ0c19kaXJ9L3NlcnZlci1rZXkucGVtIiwKICAidGxzY2FjZXJ0IjogIiR7Y2VydHNfZGlyfS9jYS5wZW0iLAogICJtdHUiOiAke210dX0sCiAgImRhdGEtcm9vdCI6ICIvc2NyYXRjaC9kb2NrZXIiLAogICJ0bHN2ZXJpZnkiOiB0cnVlCn0KRU9GCgogIHRyYXAgc3RvcF9kb2NrZXIgRVhJVAoKICBzZXJ2aWNlIGRvY2tlciBzdGFydAoKICBleHBvcnQgRE9DS0VSX1RMU19WRVJJRlk9MQogIGV4cG9ydCBET0NLRVJfQ0VSVF9QQVRIPSQxCgogIHJjPTEKICBmb3IgaSBpbiAkKHNlcSAxIDEwMCk7IGRvCiAgICBlY2hvIHdhaXRpbmcgZm9yIGRvY2tlciB0byBjb21lIHVwLi4uCiAgICBzbGVlcCAxCiAgICBzZXQgK2UKICAgIGRvY2tlciBpbmZvCiAgICByYz0kPwogICAgc2V0IC1lCiAgICBpZiBbICIkcmMiIC1lcSAiMCIgXTsgdGhlbgogICAgICAgIGJyZWFrCiAgICBmaQogIGRvbmUKCiAgaWYgWyAiJHJjIiAtbmUgIjAiIF07IHRoZW4KICAgIGV4aXQgMQogIGZpCgogIGVjaG8gJGNlcnRzX2Rpcgp9CgpmdW5jdGlvbiBtYWluKCkgewogICMgUEFUQ0g6IEZpeCBtdWx0aS1JUCBpc3N1ZSBieSBzZWxlY3Rpbmcgb25seSB0aGUgZmlyc3Qgbm9uLWxvb3BiYWNrIElQdjQgYWRkcmVzcwogICMgT3JpZ2luYWwgY29kZSBjb3VsZCByZXR1cm4gbXVsdGlwbGUgSVBzIChlLmcuLCBjb250YWluZXIgSVAgKyBkb2NrZXIwIGJyaWRnZSBJUCkKICAjIHdoaWNoIGJyZWFrcyB0aGUgZG9ja2VyX3RscyBKU09OIHZhcmlhYmxlIGZvcm1hdHRpbmcKICBleHBvcnQgT1VURVJfQ09OVEFJTkVSX0lQPSQocnVieSAtcnNvY2tldCAtZSAncHV0cyBTb2NrZXQuaXBfYWRkcmVzc19saXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlamVjdCB7IHxhZGRyfCAhYWRkci5pcD8gfHwgYWRkci5pcHY0X2xvb3BiYWNrPyB8fCBhZGRyLmlwdjY/IH0KICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwIHsgfGFkZHJ8IGFkZHIuaXBfYWRkcmVzcyB9LmZpcnN0JykKCiAgZXhwb3J0IERPQ0tFUl9IT1NUPSJ0Y3A6Ly8ke09VVEVSX0NPTlRBSU5FUl9JUH06NDI0MyIKCiAgbG9jYWwgY2VydHNfZGlyCiAgY2VydHNfZGlyPSQobWt0ZW1wIC1kKQogIHN0YXJ0X2RvY2tlciAiJHtjZXJ0c19kaXJ9IgoKICBsb2NhbCBsb2NhbF9ib3NoX2RpcgogIGxvY2FsX2Jvc2hfZGlyPSIvdG1wL2xvY2FsLWJvc2gvZGlyZWN0b3IiCgogIGRvY2tlciBuZXR3b3JrIGNyZWF0ZSAtZCBicmlkZ2UgLS1zdWJuZXQ9MTAuMjQ1LjAuMC8xNiBkaXJlY3Rvcl9uZXR3b3JrCgogIHB1c2hkICR7Qk9TSF9ERVBMT1lNRU5UX1BBVEg6LS91c3IvbG9jYWwvYm9zaC1kZXBsb3ltZW50fSA+IC9kZXYvbnVsbAogICAgICBleHBvcnQgQk9TSF9ESVJFQ1RPUl9JUD0iMTAuMjQ1LjAuMyIKICAgICAgZXhwb3J0IEJPU0hfRU5WSVJPTk1FTlQ9ImRvY2tlci1kaXJlY3RvciIKCiAgICAgIG1rZGlyIC1wICR7bG9jYWxfYm9zaF9kaXJ9CgogICAgICBhZGRpdGlvbmFsX29wc19maWxlcz0iIgogICAgICBpZiBbICIkKGxzYl9yZWxlYXNlIC1jcykiICE9ICJqYW1teSIgXTsgdGhlbgogICAgICAgIGFkZGl0aW9uYWxfb3BzX2ZpbGVzPSItbyAvdXNyL2xvY2FsL25vYmxlLXVwZGF0ZXMueW1sIgogICAgICBmaQoKICAgICAgY29tbWFuZCBib3NoIGludCBib3NoLnltbCBcCiAgICAgICAgLW8gZG9ja2VyL2NwaS55bWwgXAogICAgICAgIC1vIGp1bXBib3gtdXNlci55bWwgXAogICAgICAgIC1vIC91c3IvbG9jYWwvbG9jYWwtcmVsZWFzZXMueW1sIFwKICAgICAgICAke2FkZGl0aW9uYWxfb3BzX2ZpbGVzfSBcCiAgICAgICAgLXYgZGlyZWN0b3JfbmFtZT1kb2NrZXIgXAogICAgICAgIC12IGludGVybmFsX2NpZHI9MTAuMjQ1LjAuMC8xNiBcCiAgICAgICAgLXYgaW50ZXJuYWxfZ3c9MTAuMjQ1LjAuMSBcCiAgICAgICAgLXYgaW50ZXJuYWxfaXA9IiR7Qk9TSF9ESVJFQ1RPUl9JUH0iIFwKICAgICAgICAtdiBkb2NrZXJfaG9zdD0iJHtET0NLRVJfSE9TVH0iIFwKICAgICAgICAtdiBuZXR3b3JrPWRpcmVjdG9yX25ldHdvcmsgXAogICAgICAgIC12IGRvY2tlcl90bHM9IntcImNhXCI6IFwiJChjYXQgJHtjZXJ0c19kaXJ9L2NhX2pzb25fc2FmZS5wZW0pXCIsXCJjZXJ0aWZpY2F0ZVwiOiBcIiQoY2F0ICR7Y2VydHNfZGlyfS9jbGllbnRfY2VydGlmaWNhdGVfanNvbl9zYWZlLnBlbSlcIixcInByaXZhdGVfa2V5XCI6IFwiJChjYXQgJHtjZXJ0c19kaXJ9L2NsaWVudF9wcml2YXRlX2tleV9qc29uX3NhZmUucGVtKVwifSIgXAogICAgICAgICR7QH0gPiAiJHtsb2NhbF9ib3NoX2Rpcn0vYm9zaC1kaXJlY3Rvci55bWwiCgogICAgICBjb21tYW5kIGJvc2ggY3JlYXRlLWVudiAiJHtsb2NhbF9ib3NoX2Rpcn0vYm9zaC1kaXJlY3Rvci55bWwiIFwKICAgICAgICAgICAgICAtLXZhcnMtc3RvcmU9IiR7bG9jYWxfYm9zaF9kaXJ9L2NyZWRzLnltbCIgXAogICAgICAgICAgICAgIC0tc3RhdGU9IiR7bG9jYWxfYm9zaF9kaXJ9L3N0YXRlLmpzb24iCgogICAgICBib3NoIGludCAiJHtsb2NhbF9ib3NoX2Rpcn0vY3JlZHMueW1sIiAtLXBhdGggL2RpcmVjdG9yX3NzbC9jYSA+ICIke2xvY2FsX2Jvc2hfZGlyfS9jYS5jcnQiCiAgICAgIGJvc2ggLWUgIiR7Qk9TSF9ESVJFQ1RPUl9JUH0iIC0tY2EtY2VydCAiJHtsb2NhbF9ib3NoX2Rpcn0vY2EuY3J0IiBhbGlhcy1lbnYgIiR7Qk9TSF9FTlZJUk9OTUVOVH0iCgogICAgICBjYXQgPDxFT0YgPiAiJHtsb2NhbF9ib3NoX2Rpcn0vZW52IgogICAgICBleHBvcnQgQk9TSF9FTlZJUk9OTUVOVD0iJHtCT1NIX0VOVklST05NRU5UfSIKICAgICAgZXhwb3J0IEJPU0hfQ0xJRU5UPWFkbWluCiAgICAgIGV4cG9ydCBCT1NIX0NMSUVOVF9TRUNSRVQ9YGJvc2ggaW50ICIke2xvY2FsX2Jvc2hfZGlyfS9jcmVkcy55bWwiIC0tcGF0aCAvYWRtaW5fcGFzc3dvcmRgCiAgICAgIGV4cG9ydCBCT1NIX0NBX0NFUlQ9IiR7bG9jYWxfYm9zaF9kaXJ9L2NhLmNydCIKCkVPRgogICAgICBzb3VyY2UgIiR7bG9jYWxfYm9zaF9kaXJ9L2VudiIKCiAgICAgIGJvc2ggLW4gdXBkYXRlLWNsb3VkLWNvbmZpZyBkb2NrZXIvY2xvdWQtY29uZmlnLnltbCAtdiBuZXR3b3JrPWRpcmVjdG9yX25ldHdvcmsKCiAgcG9wZCA+IC9kZXYvbnVsbAp9CgptYWluICRACg==
                BASE64SCRIPT
                
                chmod +x /usr/local/bin/start-bosh
                
                echo "=== Starting BOSH Director with Docker CPI (patched version) ==="
                start-bosh
                
                # Source the environment variables
                source /tmp/local-bosh/director/env
                
                echo "=== BOSH Director Environment ==="
                echo "BOSH_ENVIRONMENT: ${BOSH_ENVIRONMENT}"
                echo "BOSH_CLIENT: ${BOSH_CLIENT}"
                
                echo "=== Verifying BOSH Director ==="
                bosh env
                
                echo "=== Cloud Config ==="
                bosh cloud-config
                
                echo "=== Creating and Uploading Zookeeper Release ==="
                cd zookeeper-release
                bosh create-release --force --timestamp-version
                bosh upload-release
                cd ..
                
                echo "=== Uploading Stemcell ==="
                bosh upload-stemcell --sha1 8fbcaa623769ec29c39f4c8679337a8c95e8e4a8 \
                  https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-jammy-go_agent?v=1.632
                
                echo "=== Creating ops-file for single instance ==="
                cat > /tmp/single-instance.yml <<'OPSFILE'
                ---
                # Ops-file to deploy a single zookeeper instance instead of 5
                - type: replace
                  path: /instance_groups/name=zookeeper/instances
                  value: 1
                
                - type: replace
                  path: /instance_groups/name=zookeeper/azs
                  value: [z1]
                
                # Remove smoke-tests errand for simplicity
                - type: remove
                  path: /instance_groups/name=smoke-tests
                
                # Update stemcell to jammy
                - type: replace
                  path: /stemcells/alias=default/os
                  value: ubuntu-jammy
                OPSFILE
                
                echo "=== Deploying Zookeeper (Single Instance) ==="
                bosh -n deploy \
                  -d zookeeper \
                  zookeeper-release/manifests/zookeeper.yml \
                  -o /tmp/single-instance.yml
                
                echo "=== Deployment Status ==="
                bosh -d zookeeper instances
                
                echo "=== Zookeeper VMs ==="
                bosh -d zookeeper vms
                
                echo "=== Testing Zookeeper ==="
                # SSH into the instance and check zookeeper status
                bosh -d zookeeper ssh zookeeper/0 -c "
                  set -e
                  echo '=== Zookeeper Process Status ==='
                  sudo /var/vcap/bosh/bin/monit summary
                  
                  echo '=== Zookeeper Server Status ==='
                  echo stat | nc localhost 2181 || echo 'Could not connect to Zookeeper'
                "
                
                echo "=== Cleaning Up ==="
                bosh -d zookeeper -n delete-deployment
                
                echo "=== Pipeline Complete ==="

  - name: deploy-zookeeper-on-warden-bosh
    plan:
      - in_parallel:
          - get: bosh-warden-cpi-image
          - get: zookeeper-release
            trigger: false

      - task: start-bosh-and-deploy-zookeeper
        image: bosh-warden-cpi-image
        privileged: true
        config:
          platform: linux
          inputs:
            - name: zookeeper-release
          run:
            path: bash
            args:
              - -c
              - |
                set -euo pipefail
                
                echo "=== Creating patched start-bosh script for Noble compatibility ==="
                cp /usr/local/bin/start-bosh /usr/local/bin/start-bosh.original
                
                base64 -d > /usr/local/bin/start-bosh <<'BASE64SCRIPT'
                IyEvdXNyL2Jpbi9lbnYgYmFzaAoKc2V0IC1lCgpsb2NhbF9ib3NoX2Rpcj0iL3RtcC9sb2NhbC1ib3NoL2RpcmVjdG9yIgoKZWNobyAiPT09IFBhdGNoaW5nIEdyb290RlMgY29uZmlndXJhdGlvbiBmb3IgTm9ibGUgKFVidW50dSAyNC4wNCkgY29tcGF0aWJpbGl0eSA9PT0iCmVjaG8gIkRpc2FibGluZyBsb29wIGRldmljZSB1c2FnZSB0byB3b3JrIHdpdGggY2dyb3VwIHYyLi4uIgoKR1JPT1RGU19DT05GSUc9Ii92YXIvdmNhcC9qb2JzL2dhcmRlbi9jb25maWcvZ3Jvb3Rmc19jb25maWcueW1sIgppZiBbIC1mICIkR1JPT1RGU19DT05GSUciIF07IHRoZW4KICBlY2hvICJPcmlnaW5hbCBHcm9vdEZTIGNvbmZpZzoiCiAgY2F0ICIkR1JPT1RGU19DT05GSUciCiAgCiAgZWNobyAiIgogIGVjaG8gIkFwcGx5aW5nIHBhdGNoZXMuLi4iCiAgCiAgc2VkIC1pICdzL3N0b3JlX3NpemVfYnl0ZXM6IFswLTldKi9zdG9yZV9zaXplX2J5dGVzOiAwLycgIiRHUk9PVEZTX0NPTkZJRyIKICBzZWQgLWkgJ3Mvd2l0aF9kaXJlY3RfaW86IGZhbHNlL3dpdGhfZGlyZWN0X2lvOiB0cnVlLycgIiRHUk9PVEZTX0NPTkZJRyIKICAKICBlY2hvICIiCiAgZWNobyAiUGF0Y2hlZCBHcm9vdEZTIGNvbmZpZzoiCiAgY2F0ICIkR1JPT1RGU19DT05GSUciCiAgZWNobyAiIgpmaQoKL3Zhci92Y2FwL2pvYnMvZ2FyZGVuL2Jpbi9wcmUtc3RhcnQKL3Zhci92Y2FwL2pvYnMvZ2FyZGVuL2Jpbi9nYXJkZW5fY3RsIHN0YXJ0ICYKL3Zhci92Y2FwL2pvYnMvZ2FyZGVuL2Jpbi9wb3N0LXN0YXJ0CgphZGRpdGlvbmFsX29wc19maWxlcz0iIgppZiBbICIke1VTRV9MT0NBTF9SRUxFQVNFUzo9InRydWUifSIgIT0gImZhbHNlIiBdOyB0aGVuCiAgYWRkaXRpb25hbF9vcHNfZmlsZXM9Ii1vIC91c3IvbG9jYWwvcmVsZWFzZXMvbG9jYWwtcmVsZWFzZXMueW1sIgpmaQoKcHVzaGQgJHtCT1NIX0RFUExPWU1FTlRfUEFUSDotL3Vzci9sb2NhbC9ib3NoLWRlcGxveW1lbnR9ID4gL2Rldi9udWxsCiAgZXhwb3J0IEJPU0hfRElSRUNUT1JfSVA9IjE5Mi4xNjguNTYuNiIKCiAgbWtkaXIgLXAgJHtsb2NhbF9ib3NoX2Rpcn0KCiAgYm9zaCBpbnQgYm9zaC55bWwgXAogICAgLW8gYm9zaC1saXRlLnltbCBcCiAgICAtbyB3YXJkZW4vY3BpLnltbCBcCiAgICAtbyB1YWEueW1sIFwKICAgIC1vIGNyZWRodWIueW1sIFwKICAgIC1vIGp1bXBib3gtdXNlci55bWwgXAogICAgJHthZGRpdGlvbmFsX29wc19maWxlc30gXAogICAgLXYgZGlyZWN0b3JfbmFtZT1ib3NoLWxpdGUgXAogICAgLXYgaW50ZXJuYWxfaXA9JHtCT1NIX0RJUkVDVE9SX0lQfSBcCiAgICAtdiBpbnRlcm5hbF9ndz0xOTIuMTY4LjU2LjEgXAogICAgLXYgaW50ZXJuYWxfY2lkcj0xOTIuMTY4LjU2LjAvMjQgXAogICAgLXYgb3V0Ym91bmRfbmV0d29ya19uYW1lPU5hdE5ldHdvcmsgXAogICAgLXYgZ2FyZGVuX2hvc3Q9MTI3LjAuMC4xIFwKICAgICR7QH0gPiAiJHtsb2NhbF9ib3NoX2Rpcn0vYm9zaC1kaXJlY3Rvci55bWwiCgogIGJvc2ggY3JlYXRlLWVudiAke2xvY2FsX2Jvc2hfZGlyfS9ib3NoLWRpcmVjdG9yLnltbCBcCiAgICAtLXN0YXRlICR7bG9jYWxfYm9zaF9kaXJ9L3N0YXRlLmpzb24gXAogICAgLS12YXJzLXN0b3JlICR7bG9jYWxfYm9zaF9kaXJ9L2NyZWRzLnltbAoKICBlY2hvICJMb2NhbCBCT1NIIGRpcmVjdG9yIGRlcGxveWVkLiIKCiAgYm9zaCBpbnQgYm9zaC55bWwgXAogICAgLW8gYm9zaC1saXRlLnltbCBcCiAgICAtbyB3YXJkZW4vY3BpLnltbCBcCiAgICAtdiBkaXJlY3Rvcl9uYW1lPWJvc2gtbGl0ZSBcCiAgICAtdiBpbnRlcm5hbF9pcD0ke0JPU0hfRElSRUNUT1JfSVB9IFwKICAgIC12IGludGVybmFsX2d3PTE5Mi4xNjguNTYuMSBcCiAgICAtdiBpbnRlcm5hbF9jaWRyPTE5Mi4xNjguNTYuMC8yNCBcCiAgICAtdiBvdXRib3VuZF9uZXR3b3JrX25hbWU9TmF0TmV0d29yayBcCiAgICAtLXZhcnMtc3RvcmUgJHtsb2NhbF9ib3NoX2Rpcn0vY3JlZHMueW1sIFwKICAgIC0tdmFyLWZpbGUgZ2FyZGVuX2NhY2VydD0vdmFyL3ZjYXAvam9icy9nYXJkZW4vY29uZmlnL3NlcnZlci5jcnQgXAogICAgLS12YXItZmlsZSBnYXJkZW5fY2xpZW50X2NlcnRpZmljYXRlPS92YXIvdmNhcC9qb2JzL2dhcmRlbi9jb25maWcvY2xpZW50LmNydCBcCiAgICAtLXZhci1maWxlIGdhcmRlbl9jbGllbnRfa2V5PS92YXIvdmNhcC9qb2JzL2dhcmRlbi9jb25maWcvY2xpZW50LmtleSA+ICR7bG9jYWxfYm9zaF9kaXJ9L2Vudgpwb3BkID4gL2Rldi9udWxsCg==
                BASE64SCRIPT
                
                chmod +x /usr/local/bin/start-bosh
                
                echo "=== Starting BOSH Director with Warden CPI (patched version) ==="
                /usr/local/bin/start-bosh
                
                # Source the environment variables
                source /tmp/local-bosh/director/env
                
                echo "=== BOSH Director Environment ==="
                echo "BOSH_ENVIRONMENT: ${BOSH_ENVIRONMENT}"
                echo "BOSH_CLIENT: ${BOSH_CLIENT}"
                
                echo "=== Verifying BOSH Director ==="
                bosh env
                
                echo "=== Cloud Config ==="
                bosh cloud-config
                
                echo "=== Creating and Uploading Zookeeper Release ==="
                cd zookeeper-release
                bosh create-release --force --timestamp-version
                bosh upload-release
                cd ..
                
                echo "=== Uploading Stemcell ==="
                bosh upload-stemcell --sha1 8fbcaa623769ec29c39f4c8679337a8c95e8e4a8 \
                  https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-jammy-go_agent?v=1.632
                
                echo "=== Creating ops-file for single instance ==="
                cat > /tmp/single-instance.yml <<'OPSFILE'
                ---
                # Ops-file to deploy a single zookeeper instance instead of 5
                - type: replace
                  path: /instance_groups/name=zookeeper/instances
                  value: 1
                
                - type: replace
                  path: /instance_groups/name=zookeeper/azs
                  value: [z1]
                
                # Remove smoke-tests errand for simplicity
                - type: remove
                  path: /instance_groups/name=smoke-tests
                
                # Update stemcell to jammy
                - type: replace
                  path: /stemcells/alias=default/os
                  value: ubuntu-jammy
                OPSFILE
                
                echo "=== Deploying Zookeeper (Single Instance) ==="
                bosh -n deploy \
                  -d zookeeper \
                  zookeeper-release/manifests/zookeeper.yml \
                  -o /tmp/single-instance.yml
                
                echo "=== Deployment Status ==="
                bosh -d zookeeper instances
                
                echo "=== Zookeeper VMs ==="
                bosh -d zookeeper vms
                
                echo "=== Testing Zookeeper ==="
                # SSH into the instance and check zookeeper status
                bosh -d zookeeper ssh zookeeper/0 -c "
                  set -e
                  echo '=== Zookeeper Process Status ==='
                  sudo /var/vcap/bosh/bin/monit summary
                  
                  echo '=== Zookeeper Server Status ==='
                  echo stat | nc localhost 2181 || echo 'Could not connect to Zookeeper'
                "
                
                echo "=== Cleaning Up ==="
                bosh -d zookeeper -n delete-deployment
                
                echo "=== Pipeline Complete ==="
