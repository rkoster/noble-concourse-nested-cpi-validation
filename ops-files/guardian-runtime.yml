# Configure Concourse worker to use guardian runtime (runc backend) instead of containerd
# This matches the runtime used in upstream BOSH CI pipelines which successfully use GrootFS
# See: https://github.com/concourse/concourse-bosh-release/blob/master/jobs/worker/spec#L195-L200

- type: replace
  path: /instance_groups/name=concourse/jobs/name=worker/properties/runtime?
  value: guardian

- type: replace
  path: /instance_groups/name=concourse/jobs/name=worker/properties/garden/dns_servers?
  value:
  - 8.8.8.8
  - 1.1.1.1

- type: replace
  path: /instance_groups/name=concourse/jobs/name=worker/properties/garden/allow_host_access?
  value: true

# Disable AppArmor for Guardian containers to allow nested GrootFS mount operations
# See: https://github.com/cloudfoundry/garden-runc-release/blob/develop/jobs/garden/spec#L201-L203
# The garden-default AppArmor profile contains "deny mount," which blocks loopback mounting
- type: replace
  path: /instance_groups/name=concourse/jobs/name=worker/properties/garden/config_ini?
  value: |
    [server]
      apparmor =
